name: Deploy to Cloudflare Workers

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Install Wrangler
      run: npm install -g wrangler

    - name: Create KV Namespace (if needed)
      run: |
        echo "Checking/Creating KV Namespace..."
        # å°è¯•åˆ›å»º KV namespaceï¼Œå¦‚æœå·²å­˜åœ¨ä¼šæŠ¥é”™ä½†ä¸å½±å“éƒ¨ç½²
        if wrangler kv:namespace create "REMINDERS_KV" 2>/dev/null; then
          echo "âœ… KV namespace 'REMINDERS_KV' created successfully"
        else
          echo "â„¹ï¸ KV namespace 'REMINDERS_KV' already exists or creation failed (this is usually fine)"
        fi

    - name: Deploy to Cloudflare Workers
      run: |
        echo "Deploying to Cloudflare Workers..."
        wrangler deploy --env production
      env:
        CLOUDFLARE_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
        CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}

    - name: Get deployment URL
      id: deployment
      run: |
        # ä» wrangler è¾“å‡ºä¸­æå–éƒ¨ç½² URL
        DEPLOY_URL=$(wrangler tail --format=json --once 2>/dev/null | jq -r '.url // empty' 2>/dev/null || echo "")
        if [ -z "$DEPLOY_URL" ]; then
          DEPLOY_URL="https://cloudflare-reminder.your-subdomain.workers.dev"
        fi
        echo "DEPLOY_URL=$DEPLOY_URL" >> $GITHUB_OUTPUT
        echo "ğŸš€ Deployment successful!"
        echo "ğŸ“± Access your app at: $DEPLOY_URL"

    - name: Comment deployment URL on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ğŸš€ **Deployment successful!**\n\nğŸ“± **Access your app at:** ${{ steps.deployment.outputs.DEPLOY_URL }}\n\n**Test credentials:**\n- **Invite Code:** \`${{ secrets.INVITE_CODE || '123456' }}\`\n- **Admin:** \`${{ secrets.ADMIN_USERNAME || 'admin' }}\`\n- **Password:** \`${{ secrets.ADMIN_PASSWORD || 'admin123456' }}\``
          })

    - name: Notify deployment success
      if: github.event_name == 'push'
      run: |
        echo "ğŸ‰ Deployment completed successfully!"
        echo "ğŸŒ Your Cloudflare Worker is live at: ${{ steps.deployment.outputs.DEPLOY_URL }}"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Visit the URL above"
        echo "2. Register with invite code: ${{ secrets.INVITE_CODE || '123456' }}"
        echo "3. Login as admin with: ${{ secrets.ADMIN_USERNAME || 'admin' }} / ${{ secrets.ADMIN_PASSWORD || 'admin123456' }}"
        echo "4. Configure push notifications"
        echo "5. Add your first reminder!"